import os
import time
import json
import requests
import threading
import traceback
import ast
from typing import Any, Dict, Optional, Tuple, List

from java.util import Locale
from org.telegram.tgnet import TLRPC
from org.telegram.messenger import MessageObject, FileLoader, AndroidUtilities

from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import get_file_loader, run_on_queue, send_message, get_last_fragment
from markdown_utils import parse_markdown
from ui.settings import Header, Input, Divider, Switch, Selector, Text
from ui.bulletin import BulletinHelper
from ui.alert import AlertDialogBuilder
from android_utils import run_on_ui_thread

__id__ = "gemini_plugin_security"
__name__ = "Gemini Plugin Security"
__description__ = "Checks Extera plugin code for security risks using Google Gemini API."
__author__ = "@mihailkotovski & @mishabotov"
__version__ = "2.6.0"
__min_version__ = "11.9.1"
__icon__ = "DateRegBot_by_MoiStikiBot/5"

GEMINI_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/"
MODEL_DISPLAY_NAMES = [
    "Gemini 2.5 Flash Preview",
    "Gemini 2.0 Flash",
    "Gemini 2.0 Flash Lite"
]
MODEL_API_NAMES = [
    "gemini-2.5-flash-preview-05-20",
    "gemini-2.5-flash",
    "gemini-2.0-flash-lite"
]
DEFAULT_COMMAND = ".gpa"

DEFAULT_PROMPT_MARKDOWN = (
    "Ð¢Ñ‹ â€” Ð²ÐµÐ´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº Ð¿Ð¾ ÐºÐ¸Ð±ÐµÑ€Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸, ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ÑÑ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð½Ð° Ð°ÑƒÐ´Ð¸Ñ‚Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð´Ð»Ñ Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ° ExteraGram. Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” Ð¿Ñ€Ð¾Ð²ÐµÑÑ‚Ð¸ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°ÑƒÐ´Ð¸Ñ‚ ÐºÐ¾Ð´Ð° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° '{plugin_name}' (v{plugin_version}), Ð¾Ð¿Ð¸Ñ€Ð°ÑÑÑŒ Ð½Ð° Ð·Ð½Ð°Ð½Ð¸Ðµ ÐµÐ³Ð¾ API, Ð¸ Ð²Ñ‹Ð½ÐµÑÑ‚Ð¸ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð²ÐµÑ€Ð´Ð¸ÐºÑ‚ Ð¿Ð¾ 5-ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ð¾Ð¹ ÑˆÐºÐ°Ð»Ðµ Ñ€Ð¸ÑÐºÐ°.\n\n"
    "--- ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ExteraGram API (Ð­Ñ‚Ð¾ ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ðœ) ---\n"
    "Ð›ÑŽÐ±Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… API ExteraGram ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð¹ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð¹ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¾Ð¹, Ð° Ð½Ðµ ÑƒÐ³Ñ€Ð¾Ð·Ð¾Ð¹:\n"
    "â€¢ Ð’Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼ (client_utils): Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ send_message, send_request, get_user, get_messages_controller Ð¸ Ñ‚.Ð´.\n"
    "â€¢ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Telegram API (TLRPC): Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ TLRPC Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ send_request.\n"
    "â€¢ ÐœÐ¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (HookStrategy, HookResult): ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚ Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼ Ñ…ÑƒÐºÐ¾Ð².\n"
    "â€¢ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ UI (AlertDialogBuilder, BulletinHelper): ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð¾ÐºÐ¾Ð½ Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹.\n"
    "â€¢ Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Android (android_utils): Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ runOnUIThread, addToClipboard Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼ÐµÐ½Ð½Ñ‹Ñ… ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚, Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ¾Ð¼.\n"
    "â€¢ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ requests Ð¸Ð»Ð¸ http Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ñ Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ñ… Ð¸ Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ñ… Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð² Ñ GitHub) ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð½Ð¾Ñ€Ð¼Ð¾Ð¹.\n"
    "â€¢ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÑƒ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ /Download/ Ð¸Ð»Ð¸ ÐºÐµÑˆÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº, Ð»Ð¾Ð³Ð¾Ð² Ð¸Ð»Ð¸ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.\n"
    "--- ÐšÐ¾Ð½ÐµÑ† ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° ---\n\n"
    "ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¸ ÑˆÐºÐ°Ð»Ð° Ñ€Ð¸ÑÐºÐ¾Ð² (Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð¾Ñ‚ Ð²Ñ‹ÑÑˆÐµÐ³Ð¾ Ðº Ð½Ð¸Ð·ÑˆÐµÐ¼Ñƒ):\n"
    "1. âŒ ÐžÐ¿Ð°ÑÐ½Ð¾: Ð¯Ð²Ð½Ñ‹Ð¹ Ð²Ñ€ÐµÐ´Ð¾Ð½Ð¾ÑÐ½Ñ‹Ð¹ ÐºÐ¾Ð´. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… (ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, Ð¿Ð°Ñ€Ð¾Ð»Ð¸, ÑÐµÑÑÐ¸Ñ) Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ñ‹; Ð¸ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð¸Ð· Ð½ÐµÐ¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð² (eval, os.system); ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.\n"
    "2. ðŸ“› Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº: Ð¡ÐµÑ€ÑŒÐµÐ·Ð½Ð°Ñ ÑƒÐ³Ñ€Ð¾Ð·Ð° Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾ÑÑ‚Ð¸. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð² (ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð¸Ð¼Ñ, ÑÐ¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð², Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°) Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð±ÐµÐ· Ð¾Ñ‡ÐµÐ²Ð¸Ð´Ð½Ð¾Ð¹ Ð½Ð° Ñ‚Ð¾ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹; Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°Ð¼, SMS Ð¸Ð»Ð¸ Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸.\n"
    "3. âš ï¸ ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾: ÐŸÐ¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº (requests, socket) Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ðº Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ Ð¸Ð»Ð¸ Ð½ÐµÐ·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ñ‹Ð¼ (HTTP) ÑÐµÑ€Ð²ÐµÑ€Ð°Ð¼; Ð·Ð°Ð¿Ð¸ÑÑŒ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ð¾Ð±Ñ‰Ð¸Ñ… Ð¿Ð°Ð¿Ð¾Ðº, Ð° Ð½Ðµ Ð² Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.\n"
    "4. â” ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº: ÐÐµÐ·Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½ÐµÐ´Ð¾Ñ‡ÐµÑ‚Ñ‹, Ð½Ðµ Ð²Ð»Ð¸ÑÑŽÑ‰Ð¸Ðµ Ð½Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ. Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð±ÑƒÑ„ÐµÑ€Ñƒ Ð¾Ð±Ð¼ÐµÐ½Ð° (addToClipboard), Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ…, Ð½Ð¾ Ð½Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ñ‹Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº. Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð½Ð¾ Ð½Ðµ Ð¿Ð¾Ð²Ñ‹ÑˆÐ°Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÑƒÐ³Ñ€Ð¾Ð·Ñ‹.\n"
    "5. âœ… Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾: ÐšÐ¾Ð´ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ API ExteraGram (ÑÐ¼. ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð²Ñ‹ÑˆÐµ) Ð¸Ð»Ð¸ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Python Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑÐ²Ð¾Ð¸Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹. Ð£Ð³Ñ€Ð¾Ð·Ñ‹ Ð¸ Ð¿Ð¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚.\n\n"
    "Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Markdown):\n"
    "â—ˆ Ð’ÐµÑ€Ð´Ð¸ÐºÑ‚: [Ð­Ð¼Ð¾Ð´Ð·Ð¸] [Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ / ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº / ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ / Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº / ÐžÐ¿Ð°ÑÐ½Ð¾]\n\n"
    "â˜¶ ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: [ÐžÐ”ÐÐž ÐŸÐ Ð•Ð”Ð›ÐžÐ–Ð•ÐÐ˜Ð•, Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‰ÐµÐµ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°]\n\n"
    "â ÐÐ½Ð°Ð»Ð¸Ð·:\n"
    "â€¢ [ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´. Ð•ÑÐ»Ð¸ Ñ€Ð¸ÑÐºÐ¾Ð² Ð½ÐµÑ‚, Ð½Ð°Ð¿Ð¸ÑˆÐ¸: ÐÐ½Ð°Ð»Ð¸Ð· Ð½Ðµ Ð²Ñ‹ÑÐ²Ð¸Ð» Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹, ÑƒÐ³Ñ€Ð¾Ð¶Ð°ÑŽÑ‰Ð¸Ñ… Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸. ÐŸÐ»Ð°Ð³Ð¸Ð½ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ API ExteraGram.]\n"
    "â€¢ [ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÐšÐÐ–Ð”ÐžÐ“Ðž Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð¸ÑÐºÐ°, ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ. Ð£ÐºÐ°Ð¶Ð¸ ÐµÐ³Ð¾ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ ÑÑ‚Ð¾ Ñ€Ð¸ÑÐº.]\n\n"
    "ÐšÐ¾Ð´ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n"
    "```python\n{plugin_code}\n```"
)
DEFAULT_PROMPT_PLAINTEXT = (
    "Ð¢Ñ‹ â€” Ð²ÐµÐ´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº Ð¿Ð¾ ÐºÐ¸Ð±ÐµÑ€Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸, ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ÑÑ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð½Ð° Ð°ÑƒÐ´Ð¸Ñ‚Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð´Ð»Ñ Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ° ExteraGram. Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” Ð¿Ñ€Ð¾Ð²ÐµÑÑ‚Ð¸ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°ÑƒÐ´Ð¸Ñ‚ ÐºÐ¾Ð´Ð° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° '{plugin_name}' (v{plugin_version}), Ð¾Ð¿Ð¸Ñ€Ð°ÑÑÑŒ Ð½Ð° Ð·Ð½Ð°Ð½Ð¸Ðµ ÐµÐ³Ð¾ API, Ð¸ Ð²Ñ‹Ð½ÐµÑÑ‚Ð¸ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð²ÐµÑ€Ð´Ð¸ÐºÑ‚ Ð¿Ð¾ 5-ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ð¾Ð¹ ÑˆÐºÐ°Ð»Ðµ Ñ€Ð¸ÑÐºÐ°. ÐÐ• Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ MARKDOWN.\n\n"
    "--- ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ExteraGram API (Ð­Ñ‚Ð¾ ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ðœ) ---\n"
    "Ð›ÑŽÐ±Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… API ExteraGram ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð¹ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð¹ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¾Ð¹, Ð° Ð½Ðµ ÑƒÐ³Ñ€Ð¾Ð·Ð¾Ð¹:\n"
    "â€¢ Ð’Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼ (client_utils): Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ send_message, send_request, get_user, get_messages_controller Ð¸ Ñ‚.Ð´.\n"
    "â€¢ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Telegram API (TLRPC): Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ TLRPC Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ send_request.\n"
    "â€¢ ÐœÐ¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (HookStrategy, HookResult): ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚ Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼ Ñ…ÑƒÐºÐ¾Ð².\n"
    "â€¢ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ UI (AlertDialogBuilder, BulletinHelper): ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð¾ÐºÐ¾Ð½ Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹.\n"
    "â€¢ Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ Android (android_utils): Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ runOnUIThread, addToClipboard Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼ÐµÐ½Ð½Ñ‹Ñ… ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚, Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ¾Ð¼.\n"
    "â€¢ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ requests Ð¸Ð»Ð¸ http Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ñ Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ñ… Ð¸ Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ñ… Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð² Ñ GitHub) ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð½Ð¾Ñ€Ð¼Ð¾Ð¹.\n"
    "â€¢ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÑƒ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ /Download/ Ð¸Ð»Ð¸ ÐºÐµÑˆÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº, Ð»Ð¾Ð³Ð¾Ð² Ð¸Ð»Ð¸ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.\n"
    "--- ÐšÐ¾Ð½ÐµÑ† ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° ---\n\n"
    "ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¸ ÑˆÐºÐ°Ð»Ð° Ñ€Ð¸ÑÐºÐ¾Ð² (Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð¾Ñ‚ Ð²Ñ‹ÑÑˆÐµÐ³Ð¾ Ðº Ð½Ð¸Ð·ÑˆÐµÐ¼Ñƒ):\n"
    "1. âŒ ÐžÐ¿Ð°ÑÐ½Ð¾: Ð¯Ð²Ð½Ñ‹Ð¹ Ð²Ñ€ÐµÐ´Ð¾Ð½Ð¾ÑÐ½Ñ‹Ð¹ ÐºÐ¾Ð´. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… (ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, Ð¿Ð°Ñ€Ð¾Ð»Ð¸, ÑÐµÑÑÐ¸Ñ) Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ðµ ÑÐµÑ€Ð²ÐµÑ€Ñ‹; Ð¸ÑÐ¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð¸Ð· Ð½ÐµÐ¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð² (eval, os.system); ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.\n"
    "2. ðŸ“› Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº: Ð¡ÐµÑ€ÑŒÐµÐ·Ð½Ð°Ñ ÑƒÐ³Ñ€Ð¾Ð·Ð° Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾ÑÑ‚Ð¸. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð² (ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð¸Ð¼Ñ, ÑÐ¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð², Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°) Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð±ÐµÐ· Ð¾Ñ‡ÐµÐ²Ð¸Ð´Ð½Ð¾Ð¹ Ð½Ð° Ñ‚Ð¾ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹; Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°Ð¼, SMS Ð¸Ð»Ð¸ Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸.\n"
    "3. âš ï¸ ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾: ÐŸÐ¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº (requests, socket) Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ðº Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¼ Ð¸Ð»Ð¸ Ð½ÐµÐ·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ñ‹Ð¼ (HTTP) ÑÐµÑ€Ð²ÐµÑ€Ð°Ð¼; Ð·Ð°Ð¿Ð¸ÑÑŒ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ð¾Ð±Ñ‰Ð¸Ñ… Ð¿Ð°Ð¿Ð¾Ðº, Ð° Ð½Ðµ Ð² Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.\n"
    "4. â” ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº: ÐÐµÐ·Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½ÐµÐ´Ð¾Ñ‡ÐµÑ‚Ñ‹, Ð½Ðµ Ð²Ð»Ð¸ÑÑŽÑ‰Ð¸Ðµ Ð½Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ. Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð±ÑƒÑ„ÐµÑ€Ñƒ Ð¾Ð±Ð¼ÐµÐ½Ð° (addToClipboard), Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ…, Ð½Ð¾ Ð½Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ñ‹Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº. Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð½Ð¾ Ð½Ðµ Ð¿Ð¾Ð²Ñ‹ÑˆÐ°Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÑƒÐ³Ñ€Ð¾Ð·Ñ‹.\n"
    "5. âœ… Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾: ÐšÐ¾Ð´ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ API ExteraGram (ÑÐ¼. ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð²Ñ‹ÑˆÐµ) Ð¸Ð»Ð¸ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Python Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑÐ²Ð¾Ð¸Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹. Ð£Ð³Ñ€Ð¾Ð·Ñ‹ Ð¸ Ð¿Ð¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚.\n\n"
    "Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° (Ð¢ÐžÐ›Ð¬ÐšÐž ÐžÐ‘Ð«Ð§ÐÐ«Ð™ Ð¢Ð•ÐšÐ¡Ð¢):\n"
    "â—ˆ Ð’ÐµÑ€Ð´Ð¸ÐºÑ‚: [Ð­Ð¼Ð¾Ð´Ð·Ð¸] [Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ / ÐÐ¸Ð·ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº / ÐžÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ / Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ñ€Ð¸ÑÐº / ÐžÐ¿Ð°ÑÐ½Ð¾]\n"
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    "â˜¶ ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: [ÐžÐ”ÐÐž ÐŸÐ Ð•Ð”Ð›ÐžÐ–Ð•ÐÐ˜Ð•, Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‰ÐµÐµ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°]\n"
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    "â ÐÐ½Ð°Ð»Ð¸Ð·:\n"
    "â€¢ [ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´. Ð•ÑÐ»Ð¸ Ñ€Ð¸ÑÐºÐ¾Ð² Ð½ÐµÑ‚, Ð½Ð°Ð¿Ð¸ÑˆÐ¸: ÐÐ½Ð°Ð»Ð¸Ð· Ð½Ðµ Ð²Ñ‹ÑÐ²Ð¸Ð» Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹, ÑƒÐ³Ñ€Ð¾Ð¶Ð°ÑŽÑ‰Ð¸Ñ… Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸. ÐŸÐ»Ð°Ð³Ð¸Ð½ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ API ExteraGram.]\n"
    "â€¢ [ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÐšÐÐ–Ð”ÐžÐ“Ðž Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð¸ÑÐºÐ°, ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ. Ð£ÐºÐ°Ð¶Ð¸ ÐµÐ³Ð¾ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ ÑÑ‚Ð¾ Ñ€Ð¸ÑÐº.]\n\n"
    "ÐšÐ¾Ð´ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n"
    "python\n{plugin_code}\n"
)

class AlertManager:
    """Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ð¾ÐºÐ¾Ð½."""
    def __init__(self):
        self.alert_builder_instance: Optional[AlertDialogBuilder] = None

    def show_info_alert(self, title: str, message: str, positive_button: str):
        last_fragment = get_last_fragment()
        if not last_fragment or not last_fragment.getParentActivity(): return
        context = last_fragment.getParentActivity()
        builder = AlertDialogBuilder(context, AlertDialogBuilder.ALERT_TYPE_MESSAGE)
        self.alert_builder_instance = builder
        builder.set_title(title)
        builder.set_message(message)
        builder.set_positive_button(positive_button, lambda d, w: self.dismiss_dialog())
        builder.set_cancelable(True)
        builder.set_canceled_on_touch_outside(True)
        run_on_ui_thread(builder.show)

    def dismiss_dialog(self):
        if self.alert_builder_instance and self.alert_builder_instance.get_dialog() and self.alert_builder_instance.get_dialog().isShowing():
            self.alert_builder_instance.dismiss()
            self.alert_builder_instance = None


class LocalizationManager:
    """Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð»Ð¾ÐºÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ ÑÑ‚Ñ€Ð¾Ðº Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°."""
    strings = {
        "ru": {
            "SETTINGS_HEADER": "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Gemini Security",
            "API_KEY_INPUT": "API Key",
            "API_KEY_SUBTEXT": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ ÐºÐ»ÑŽÑ‡ Ð² Google AI Studio.",
            "GET_API_KEY_BUTTON": "Ð¡ÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ»ÑŽÑ‡Ð°",
            "MODEL_SELECTOR": "ÐœÐ¾Ð´ÐµÐ»ÑŒ",
            "MODEL_SELECTOR_SUBTEXT": "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð˜Ð˜ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°. Flash Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ, Pro - Ð¼Ð¾Ñ‰Ð½ÐµÐµ.",
            "PROMPT_INPUT_MD": "ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚ (Markdown)",
            "PROMPT_INPUT_PLAIN": "ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚ (Ð¦Ð¸Ñ‚Ð°Ñ‚Ð°)",
            "PROMPT_SUBTEXT": "Ð¨Ð°Ð±Ð»Ð¾Ð½ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ {plugin_code}, {plugin_name}, {plugin_version}.",
            "ENABLE_SWITCH": "Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐºÐ°Ð½ÐµÑ€",
            "USAGE_HEADER": "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ",
            "USAGE_INFO_TITLE": "FAQ",
            "USAGE_INFO_TEXT": (
                "Ð­Ñ‚Ð¾Ñ‚ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿Ð¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¸Ð»Ð¸ Ð²Ñ€ÐµÐ´Ð¾Ð½Ð¾ÑÐ½Ñ‹Ñ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚Ð¸ Google Gemini.\n\n"
                "**Ð¨Ð°Ð³ 1: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°**\n"
                "1. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ API-ÐºÐ»ÑŽÑ‡ Ð² Google AI Studio.\n"
                "2. Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ»ÑŽÑ‡ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐµ Ð¿Ð¾Ð»Ðµ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.\n\n"
                "**Ð¨Ð°Ð³ 2: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ**\n"
                "1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð¼ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ (Ñ„Ð°Ð¹Ð» Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¸Ð¼ÐµÑ‚ÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ `.plugin` Ð¸Ð»Ð¸ `.py`).\n"
                f"2. ÐžÑ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹: `{DEFAULT_COMMAND}`\n\n"
                "ÐŸÐ»Ð°Ð³Ð¸Ð½ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ ÐºÐ¾Ð´ Ð½Ð° Ð°Ð½Ð°Ð»Ð¸Ð· Ð¸ Ð¿Ñ€Ð¸ÑˆÐ»ÐµÑ‚ Ð²Ð°Ð¼ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð² ÑÑ‚Ð¾Ñ‚ Ð¶Ðµ Ñ‡Ð°Ñ‚."
            ),
            "API_KEY_MISSING": "âŒ API ÐºÐ»ÑŽÑ‡ Ð´Ð»Ñ Gemini Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.",
            "NO_REPLY": "âŒ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð¼ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.",
            "NOT_A_PLUGIN": "âŒ Ð¤Ð°Ð¹Ð» Ð² Ð¾Ñ‚Ð²ÐµÑ‡ÐµÐ½Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð¼ (.plugin Ð¸Ð»Ð¸ .py).",
            "ANALYZING_MESSAGE": "ðŸ›¡ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð½Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ...",
            "API_ERROR": "âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° API Gemini: {error}",
            "FILE_DOWNLOAD_ERROR": "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.",
            "FILE_READ_ERROR": "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°.",
            "UNEXPECTED_ERROR": "â— ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°: {error}",
            "SUCCESS_HEADER_MD": "ðŸ›¡ï¸ **ÐžÑ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸: {plugin_name} v{plugin_version}**\n\n",
            "SUCCESS_HEADER_PLAIN": "ðŸ›¡ï¸ ÐžÑ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸: {plugin_name} v{plugin_version}\n\n",
            "ALERT_CLOSE_BUTTON": "Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ",
            "USE_BLOCKQUOTE_TITLE": "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñƒ",
            "USE_BLOCKQUOTE_SUBTEXT": "ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð² Ð²Ð¸Ð´Ðµ ÑÐ²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼Ð¾Ð¹ Ñ†Ð¸Ñ‚Ð°Ñ‚Ñ‹ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ð¾ÑÑ‚Ð¸.",
            "APPEARANCE_HEADER": "Ð’Ð½ÐµÑˆÐ½Ð¸Ð¹ Ð²Ð¸Ð´",
        },
        "en": {
            "SETTINGS_HEADER": "Gemini Security Settings",
            "API_KEY_INPUT": "API Key",
            "API_KEY_SUBTEXT": "Get your key from Google AI Studio.",
            "GET_API_KEY_BUTTON": "Link to get API Key",
            "MODEL_SELECTOR": "Model",
            "MODEL_SELECTOR_SUBTEXT": "Select the AI model for analysis. Flash is faster, Pro is more powerful.",
            "PROMPT_INPUT_MD": "Prompt (Markdown)",
            "PROMPT_INPUT_PLAIN": "Prompt (Blockquote)",
            "PROMPT_SUBTEXT": "Request template. Use {plugin_code}, {plugin_name}, {plugin_version}.",
            "ENABLE_SWITCH": "Enable Scanner",
            "USAGE_HEADER": "Usage",
            "USAGE_INFO_TITLE": "FAQ",
            "USAGE_INFO_TEXT": (
                "This plugin helps you check the code of other plugins for suspicious or malicious activity using the Google Gemini neural network.\n\n"
                "**Step 1: Setup**\n"
                "1. Get your API key from Google AI Studio.\n"
                "2. Paste the key into the corresponding field in the plugin settings.\n\n"
                "**Step 2: Usage**\n"
                "1. Find a message with the plugin file you want to scan (the file must have a `.plugin` or `.py` extension).\n"
                f"2. Reply to this message with the command: `{DEFAULT_COMMAND}`\n\n"
                "The plugin will send the code for analysis and send you a security report in the same chat."
            ),
            "API_KEY_MISSING": "âŒ Gemini API key not found. Please set it in the plugin settings.",
            "NO_REPLY": "âŒ Please reply to a message containing a plugin file.",
            "NOT_A_PLUGIN": "âŒ The replied message does not contain a plugin file (.plugin or .py).",
            "ANALYZING_MESSAGE": "ðŸ›¡ï¸ Scanning plugin for safety...",
            "API_ERROR": "âš ï¸ Gemini API Error: {error}",
            "FILE_DOWNLOAD_ERROR": "âŒ Failed to download the plugin file.",
            "FILE_READ_ERROR": "âŒ Failed to read the plugin file.",
            "UNEXPECTED_ERROR": "â— An unexpected error occurred: {error}",
            "SUCCESS_HEADER_MD": "ðŸ›¡ï¸ **Security Report: {plugin_name} v{plugin_version}**\n\n",
            "SUCCESS_HEADER_PLAIN": "ðŸ›¡ï¸ Security Report: {plugin_name} v{plugin_version}\n\n",
            "ALERT_CLOSE_BUTTON": "Close",
            "USE_BLOCKQUOTE_TITLE": "Use blockquote",
            "USE_BLOCKQUOTE_SUBTEXT": "Display the report as a collapsible blockquote for compactness.",
            "APPEARANCE_HEADER": "Appearance",
        }
    }

    def __init__(self):
        self.language = Locale.getDefault().getLanguage()
        self.language = self.language if self.language in self.strings else "en"

    def get_string(self, key: str) -> str:
        return self.strings[self.language].get(key, self.strings["en"].get(key, key))

locali = LocalizationManager()

class GeminiAPIHandler:
    """ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº Google Gemini API."""
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "Content-Type": "application/json",
            "User-Agent": f"ExteraPlugin/{__id__}/{__version__}"
        })

    def analyze_plugin_code(self, api_key: str, model_name: str, prompt: str) -> Dict[str, Any]:
        url = f"{GEMINI_BASE_URL}{model_name}:generateContent?key={api_key}"
        payload = {
            "contents": [{"parts": [{"text": prompt}]}],
            "generationConfig": {
                "temperature": 0.5,
                "maxOutputTokens": 500000,
            }
        }
        try:
            response = self.session.post(url, json=payload, timeout=90)
            response.raise_for_status()
            data = response.json()
            if "candidates" in data and data["candidates"][0].get("content", {}).get("parts", [{}])[0].get("text"):
                return {"success": True, "text": data["candidates"][0]["content"]["parts"][0]["text"]}
            else:
                error_details = data.get("error", {}).get("message", "Invalid API response format.")
                return {"success": False, "error": error_details}
        except requests.exceptions.HTTPError as e:
            error_text = f"HTTP {e.response.status_code}"
            try: error_text += f": {e.response.json().get('error',{}).get('message', e.response.text)}"
            except: error_text += f": {e.response.text}"
            return {"success": False, "error": error_text}
        except requests.exceptions.RequestException as e: return {"success": False, "error": f"Network error: {str(e)}"}
        except Exception as e: return {"success": False, "error": f"Unexpected error: {str(e)}"}


class GeminiPluginAnalyzer(BasePlugin):
    """ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÐºÐ»Ð°ÑÑ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°."""
    def __init__(self):
        super().__init__()
        self.api_handler = GeminiAPIHandler()
        self.alert_manager = AlertManager()

    def on_plugin_load(self):
        self.add_on_send_message_hook()

    def on_plugin_unload(self):
        self.alert_manager.dismiss_dialog()

    def _copy_to_clipboard(self, text: str):
        if AndroidUtilities.addToClipboard(text):
            BulletinHelper.show_copied_to_clipboard()

    def _show_error_bulletin(self, key: str, **kwargs):
        message = locali.get_string(key).format(**kwargs)
        run_on_ui_thread(lambda: BulletinHelper.show_error(message))

    def _handle_show_info_alert_click(self, view):
        title = locali.get_string("USAGE_INFO_TITLE")
        text = locali.get_string("USAGE_INFO_TEXT")
        close_button = locali.get_string("ALERT_CLOSE_BUTTON")
        parsed_text = parse_markdown(text)
        self.alert_manager.show_info_alert(title, parsed_text.text, close_button)

    def create_settings(self) -> List[Any]:
        return [
            Header(text=locali.get_string("SETTINGS_HEADER")),
            Switch(key="enabled", text=locali.get_string("ENABLE_SWITCH"), icon="menu_privacy_policy", default=True),
            Input(key="gemini_api_key", text=locali.get_string("API_KEY_INPUT"), icon="msg_limit_links", default="", subtext=locali.get_string("API_KEY_SUBTEXT")),
            Text(
                text=locali.get_string("GET_API_KEY_BUTTON"),
                icon="msg_link",
                accent=True,
                on_click=lambda view: self._copy_to_clipboard("https://aistudio.google.com/app/apikey")
            ),
            Divider(),
            Header(text="Model and Prompt"),
            Selector(key="model_selection", text=locali.get_string("MODEL_SELECTOR"), icon="msg_media", default=0, items=MODEL_DISPLAY_NAMES),
            Divider(text=locali.get_string("MODEL_SELECTOR_SUBTEXT")),
            Input(key="custom_prompt_md", text=locali.get_string("PROMPT_INPUT_MD"), icon="filled_unknown", default=DEFAULT_PROMPT_MARKDOWN),
            Input(key="custom_prompt_plain", text=locali.get_string("PROMPT_INPUT_PLAIN"), icon="filled_unknown", default=DEFAULT_PROMPT_PLAINTEXT),
            Divider(),
            Header(text=locali.get_string("APPEARANCE_HEADER")),
            Switch(
                key="use_blockquote",
                text=locali.get_string("USE_BLOCKQUOTE_TITLE"),
                subtext=locali.get_string("USE_BLOCKQUOTE_SUBTEXT"),
                icon="msg_quote",
                default=True
            ),
            Divider(),
            Text(text=locali.get_string("USAGE_INFO_TITLE"), icon="msg_info", on_click=self._handle_show_info_alert_click)
        ]

    def _get_plugin_metadata(self, code: str) -> Tuple[str, str]:
        """Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚ Ð¸Ð¼Ñ Ð¸ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° Ð¸Ð· ÐºÐ¾Ð´Ð° Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ AST."""
        name = "Unknown Plugin"; version = "Unknown Version"
        try:
            tree = ast.parse(code)
            for node in ast.walk(tree):
                if isinstance(node, ast.Assign):
                    for target in node.targets:
                        if isinstance(target, ast.Name):
                            if target.id == "__name__": name = ast.literal_eval(node.value)
                            elif target.id == "__version__": version = ast.literal_eval(node.value)
        except Exception:
            pass
        return name, version

    def _wait_for_file(self, file_path: str, document: Any) -> bool:
        """ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð°, Ð¸Ð½Ð¸Ñ†Ð¸Ð¸Ñ€ÑƒÑ ÐµÐ³Ð¾, ÐµÑÐ»Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾."""
        if os.path.exists(file_path): return True
        get_file_loader().loadFile(document, "gemini_analyzer", FileLoader.PRIORITY_HIGH, 1)
        for _ in range(30):
            if os.path.exists(file_path): return True
            time.sleep(1)
        return False

    def _process_analysis_in_background(self, peer: int, document: Any):
        """Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ Ð²ÐµÑÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ð¿Ð¾Ñ‚Ð¾ÐºÐµ."""
        try:
            file_path_obj = get_file_loader().getPathToAttach(document, True)
            if not self._wait_for_file(file_path_obj.getAbsolutePath(), document):
                self._show_error_bulletin("FILE_DOWNLOAD_ERROR")
                return

            try:
                with open(file_path_obj.getAbsolutePath(), "r", encoding="utf-8", errors="ignore") as f:
                    plugin_code = f.read()
                plugin_name, plugin_version = self._get_plugin_metadata(plugin_code)
            except Exception as e:
                self._show_error_bulletin("FILE_READ_ERROR", e=str(e))
                return

            api_key = self.get_setting("gemini_api_key", "")
            model_idx = self.get_setting("model_selection", 0)
            model_name = MODEL_API_NAMES[model_idx]
            use_blockquote = self.get_setting("use_blockquote", True)
            
            if use_blockquote:
                prompt_template = self.get_setting("custom_prompt_plain", DEFAULT_PROMPT_PLAINTEXT)
            else:
                prompt_template = self.get_setting("custom_prompt_md", DEFAULT_PROMPT_MARKDOWN)

            full_prompt = prompt_template.format(plugin_code=plugin_code, plugin_name=plugin_name, plugin_version=plugin_version)
            result = self.api_handler.analyze_plugin_code(api_key, model_name, full_prompt)
            
            if result.get("success"):
                self._send_report(peer, result["text"], plugin_name, plugin_version, use_blockquote)
            else: 
                self._show_error_bulletin("API_ERROR", error=result.get("error", "Unknown"))

        except Exception as e:
            self._show_error_bulletin("UNEXPECTED_ERROR", error=str(e))
            traceback.print_exc()

    def _send_report(self, peer: int, response_text: str, plugin_name: str, plugin_version: str, use_blockquote: bool):
        """Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸."""
        header_key = "SUCCESS_HEADER_PLAIN" if use_blockquote else "SUCCESS_HEADER_MD"
        header = locali.get_string(header_key).format(plugin_name=plugin_name, plugin_version=plugin_version)
        report_text = header + response_text
        
        try:
            if use_blockquote:
                blockquote_entity = TLRPC.TL_messageEntityBlockquote()
                blockquote_entity.collapsed = True
                blockquote_entity.offset = 0
                blockquote_entity.length = len(report_text.encode('utf_16_le')) // 2
                send_message({"peer": peer, "message": report_text, "entities": [blockquote_entity]})
            else:
                parsed = parse_markdown(report_text)
                tl_entities = [entity.to_tlrpc_object() for entity in parsed.entities] if parsed.entities else None
                send_message({"peer": peer, "message": parsed.text, "entities": tl_entities})
        except Exception:
            fallback_text = report_text.replace('**', '').replace('__', '').replace('`', '')
            send_message({"peer": peer, "message": fallback_text})

        verdict_line = response_text.split('\n', 1)[0].strip()
        clean_verdict = verdict_line.replace("â—ˆ Ð’ÐµÑ€Ð´Ð¸ÐºÑ‚:", "").strip()
        
        def show_verdict_bulletin():
            if "âœ…" in verdict_line:
                BulletinHelper.show_success(clean_verdict)
            elif "âŒ" in verdict_line or "ðŸ“›" in verdict_line:
                BulletinHelper.show_error(clean_verdict)
            else:
                BulletinHelper.show_info(clean_verdict)
        run_on_ui_thread(show_verdict_bulletin)

    def on_send_message_hook(self, account: int, params: Any) -> HookResult:
        if not hasattr(params, "message") or not isinstance(params.message, str): return HookResult()
        
        message_text = params.message.strip()
        if message_text.lower() != DEFAULT_COMMAND or not self.get_setting("enabled", True): return HookResult()
        
        api_key = self.get_setting("gemini_api_key", "")
        if not api_key:
            self._show_error_bulletin("API_KEY_MISSING")
            return HookResult(strategy=HookStrategy.CANCEL)
        
        if not params.replyToMsg:
            self._show_error_bulletin("NO_REPLY")
            return HookResult(strategy=HookStrategy.CANCEL)
            
        document = MessageObject.getDocument(params.replyToMsg.messageOwner)
        if not document or not any(str(document.file_name_fixed).endswith(ext) for ext in [".plugin", ".py"]):
            self._show_error_bulletin("NOT_A_PLUGIN")
            return HookResult(strategy=HookStrategy.CANCEL)
            
        BulletinHelper.show_info(locali.get_string("ANALYZING_MESSAGE"))
        run_on_queue(lambda: self._process_analysis_in_background(params.peer, document))
        return HookResult(strategy=HookStrategy.CANCEL)